# Production SPIRE Agent Configuration
# AML-KYC Agent Zero Trust Identity Management

agent:
  data_dir: "/opt/spire/data/agent"
  log_level: "INFO"
  log_format: "json"
  trust_domain: "aml-advisory.company.com"
  server_address: "spire-server.spire-system.svc.cluster.local"
  server_port: "8081"
  
  # Workload API Configuration
  workload_api:
    bind_address: "127.0.0.1"
    bind_port: "8082"
    socket_path: "/tmp/spire-agent.sock"
    trust_domain: "aml-advisory.company.com"
  
  # Plugin Configuration
  plugins:
    # Node Attestor - Kubernetes PSAT for node attestation
    NodeAttestor:
      k8s_psat:
        plugin_data:
          cluster: "production"
          token_file: "/var/run/secrets/kubernetes.io/serviceaccount/token"
          cert_file: "/var/run/secrets/kubernetes.io/serviceaccount/ca.crt"
    
    # Key Manager - Memory-based key storage
    KeyManager:
      memory:
        plugin_data: {}
    
    # Workload Attestor - Unix domain socket for workload attestation
    WorkloadAttestor:
      unix:
        plugin_data:
          discover_workload_path: true
          workload_size_limit: 1048576  # 1MB
    
    # Workload Attestor - Kubernetes for pod attestation
      k8s:
        plugin_data:
          kubelet_read_only_port: 10255
          skip_kubelet_verification: false
          node_name_env: "KUBERNETES_NODE_NAME"
          pod_label: "spiffe.io/workload"
          pod_annotation: "spiffe.io/workload"
    
    # Workload Attestor - Docker for container attestation
      docker:
        plugin_data:
          docker_socket_path: "/var/run/docker.sock"
          container_id_cgroup_matchers:
            - "/docker/<id>"
            - "/docker-ce/docker/<id>"

# Telemetry Configuration
telemetry:
  prometheus:
    port: "8083"
    listen_socket: "/tmp/spire-agent.sock"
  
  # Metrics configuration
  metrics:
    - name: "agent_entries"
      help: "Number of entries in the agent"
      type: "gauge"
    - name: "agent_attestations"
      help: "Number of attestations processed"
      type: "counter"
    - name: "agent_certificates_issued"
      help: "Number of certificates issued"
      type: "counter"

# Health Check Configuration
health_checks:
  listener_enabled: true
  bind_address: "127.0.0.1"
  bind_port: "8081"
  live_path: "/live"
  ready_path: "/ready"

# Audit Logging Configuration
audit_log:
  enabled: true
  log_level: "INFO"
  log_format: "json"
  log_file: "/opt/spire/logs/audit.log"
  max_size_mb: 50
  max_backups: 3
  max_age_days: 7
  compress: true

# Security Configuration
security:
  # Certificate validity periods
  default_svid_ttl: "1h"
  
  # Rate limiting
  rate_limit:
    enabled: true
    requests_per_second: 50
    burst_size: 100

# Workload Configuration
workload:
  # Workload registration
  registration:
    enabled: true
    auto_register: true
    registration_ttl: "24h"
  
  # Workload validation
  validation:
    enabled: true
    strict_validation: true
    allow_unregistered_workloads: false
