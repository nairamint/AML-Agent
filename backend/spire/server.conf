# Production SPIRE Server Configuration
# AML-KYC Agent Zero Trust Identity Management

server:
  bind_address: "0.0.0.0"
  bind_port: "8081"
  trust_domain: "aml-advisory.company.com"
  data_dir: "/opt/spire/data/server"
  log_level: "INFO"
  log_format: "json"
  
  # Certificate Authority Configuration
  ca_subject:
    country: ["UK"]
    organization: ["AML Advisory Agent"]
    organizational_unit: ["Security Team"]
    common_name: "SPIRE Server CA"
    locality: ["London"]
    province: ["England"]
  
  # Plugin Configuration
  plugins:
    # Data Store - PostgreSQL for production persistence
    DataStore:
      sql:
        plugin_data:
          database_type: "postgres"
          connection_string: "postgres://spire:${SPIRE_DB_PASSWORD}@postgres:5432/spire?sslmode=require"
          max_open_conns: 25
          max_idle_conns: 5
          conn_max_lifetime: "1h"
          conn_max_idle_time: "30m"
    
    # Node Attestor - Kubernetes PSAT for workload attestation
    NodeAttestor:
      k8s_psat:
        plugin_data:
          clusters:
            production:
              service_account_allow_list: 
                - "spire:spire-agent"
                - "aml-kyc:aml-kyc-backend"
                - "aml-kyc:aml-kyc-frontend"
                - "aml-kyc:aml-kyc-llm"
              kube_config_file: "/opt/spire/conf/kubeconfig"
    
    # Key Manager - Disk-based key storage with encryption
    KeyManager:
      disk:
        plugin_data:
          keys_path: "/opt/spire/data/server/keys.json"
          password: "${SPIRE_KEY_PASSWORD}"
    
    # Upstream Authority - Self-signed CA for development
    UpstreamAuthority:
      disk:
        plugin_data:
          key_file_path: "/opt/spire/conf/server.key"
          cert_file_path: "/opt/spire/conf/server.crt"
    
    # Notifier - Kubernetes for workload notifications
    Notifier:
      k8sbundle:
        plugin_data:
          namespace: "spire-system"
          config_map: "spire-bundle"
          config_map_key: "bundle.crt"
          kube_config_file: "/opt/spire/conf/kubeconfig"

# Telemetry Configuration
telemetry:
  prometheus:
    port: "8082"
    listen_socket: "/tmp/spire-server.sock"
  
  # Metrics configuration
  metrics:
    - name: "server_entries"
      help: "Number of entries in the server"
      type: "gauge"
    - name: "server_attestations"
      help: "Number of attestations processed"
      type: "counter"
    - name: "server_certificates_issued"
      help: "Number of certificates issued"
      type: "counter"

# Health Check Configuration
health_checks:
  listener_enabled: true
  bind_address: "0.0.0.0"
  bind_port: "8080"
  live_path: "/live"
  ready_path: "/ready"

# Audit Logging Configuration
audit_log:
  enabled: true
  log_level: "INFO"
  log_format: "json"
  log_file: "/opt/spire/logs/audit.log"
  max_size_mb: 100
  max_backups: 5
  max_age_days: 30
  compress: true

# Security Configuration
security:
  # JWT signing key rotation
  jwt_signing_key_rotation_interval: "24h"
  
  # Certificate validity periods
  default_svid_ttl: "1h"
  default_bundle_ttl: "24h"
  
  # Rate limiting
  rate_limit:
    enabled: true
    requests_per_second: 100
    burst_size: 200

# Federation Configuration (for multi-cluster)
federation:
  enabled: false
  # Uncomment and configure for multi-cluster deployment
  # bundles_endpoint:
  #   address: "0.0.0.0"
  #   port: "8443"
  #   acme:
  #     domain_name: "spire.aml-advisory.company.com"
  #     email: "security@aml-advisory.company.com"
  #     tos_accepted: true
